# 图像切片预处理方案

用于将大尺寸病理切片图像（如NDPI格式）切割成固定大小的小图像块，适用于深度学习模型训练。

## 方案特点

- **滑动窗口切片**: 512x512像素，重叠64像素
- **自动放大倍数匹配**: 自动选择最接近目标倍数（20x）的金字塔层级
- **智能背景过滤**: 自动跳过空白/背景区域，只保存有组织的切片
- **元数据记录**: 保存每个切片的位置信息，便于后续重建
- **批量处理**: 支持一次处理多个图像
- **进度显示**: 实时显示处理进度

## 安装依赖

```bash
pip install -r requirements.txt
```

### 依赖说明

- `openslide-python`: 读取全扫描切片图像（NDPI、SVS等）
- `Pillow`: 图像处理
- `numpy`: 数值计算
- `tqdm`: 进度条显示
- `pyyaml`: 配置文件解析

**注意**: Windows用户需要额外下载OpenSlide二进制文件:
1. 访问 https://openslide.org/download/
2. 下载Windows binaries
3. 解压并添加到系统PATH

## 使用方法

### 1. 配置参数

编辑 `config.yaml` 文件：

```yaml
tile_size: 512                  # 切片大小
overlap: 64                     # 重叠像素
target_magnification: 20.0      # 目标放大倍数
background_threshold: 0.8       # 背景阈值
min_tissue_ratio: 0.1          # 最小组织占比
output_base_dir: "output_tiles" # 输出目录
```

### 2. 处理单个图像

```bash
python image_slicer.py
```

或者使用批处理脚本：

```bash
python batch_process.py --image "DC2200025 A4 CD34.ndpi"
```

### 3. 批量处理多个图像

```bash
python batch_process.py --batch
```

这将处理当前目录下所有支持格式的图像文件（.ndpi, .svs, .tiff, .tif）

## 输出结构

```
output_tiles/
├── DC2200025 A4 CD34/
│   ├── tile_0_0.png
│   ├── tile_0_448.png
│   ├── tile_0_896.png
│   ├── ...
│   └── metadata.json
└── DC2200155 A3 CD34/
    ├── tile_0_0.png
    ├── ...
    └── metadata.json
```

### 元数据格式 (metadata.json)

```json
{
  "source_image": "DC2200025 A4 CD34.ndpi",
  "tile_size": 512,
  "overlap": 64,
  "stride": 448,
  "target_magnification": 20.0,
  "actual_magnification": 20.02,
  "level": 1,
  "saved_tiles": 1234,
  "tiles": [
    {
      "filename": "tile_0_0.png",
      "x": 0,
      "y": 0,
      "x_level0": 0,
      "y_level0": 0,
      "level": 1,
      "size": 512
    }
  ]
}
```

## 算法说明

### 滑动窗口计算

- **切片大小**: 512 × 512 像素
- **重叠区域**: 64 像素
- **步长**: 512 - 64 = 448 像素

```
+--------+
|   512  |
|  +--------+
|  | 64|    |
+--+---+    |
   |   512  |
   +--------+

stride = 448px
```

### 背景过滤算法

1. 将RGB切片转换为灰度图
2. 计算高于阈值（0.8）的像素占比
3. 如果组织占比 < 10%，则认为是背景，跳过该切片

### 放大倍数匹配

NDPI文件包含多个金字塔层级，算法会：
1. 读取基础放大倍数（通常是40x）
2. 计算每个层级的实际放大倍数
3. 选择最接近目标倍数（20x）的层级

## 参数调优建议

### tile_size (切片大小)
- **512**: 适合大多数深度学习模型（ResNet、VGG等）
- **256**: 更小的模型或GPU内存有限时使用
- **1024**: 需要更大感受野时使用

### overlap (重叠)
- **64**: 标准配置，约12.5%重叠
- **128**: 更多重叠，适合边缘信息重要的任务
- **0**: 无重叠，最快速度但可能丢失边缘信息

### background_threshold (背景阈值)
- **0.8**: 标准白色背景
- **0.7**: 背景稍暗时降低阈值
- **0.9**: 背景很白时提高阈值

### min_tissue_ratio (最小组织占比)
- **0.1**: 标准配置，过滤掉90%以上是背景的切片
- **0.2**: 更严格，只保留组织丰富的切片
- **0.05**: 更宽松，保留更多边缘切片

## 性能优化

1. **内存使用**: 一次只加载一个切片，适合处理TB级图像
2. **磁盘IO**: 使用PNG格式保存，平衡质量和速度
3. **并行处理**: 可修改代码使用multiprocessing加速

## 常见问题

### Q: 为什么有些切片被跳过？
A: 背景过滤算法会跳过主要是空白区域的切片。可以调整 `min_tissue_ratio` 参数。

### Q: 如何查看原图的放大倍数？
A: 运行程序时会自动显示检测到的放大倍数信息。

### Q: 切片命名规则是什么？
A: `tile_{y}_{x}.png`，其中y和x是在选定层级下的像素坐标。

### Q: 如何从切片恢复原图？
A: 使用 `metadata.json` 中的坐标信息，按照位置拼接切片。

## 扩展功能

可以根据需求添加以下功能：

1. **数据增强**: 在切片时进行旋转、翻转等
2. **质量控制**: 计算切片的清晰度、染色质量等指标
3. **可视化**: 生成切片位置的缩略图
4. **分布式处理**: 使用Dask或Ray进行大规模并行处理

## 许可证

MIT License
